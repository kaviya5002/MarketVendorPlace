<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyer Dashboard - Campus Ecommerce</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">ðŸ›’ Campus Ecommerce</h1>
            <div class="nav-links">
                <span id="userName" class="user-name"></span>
                <span class="cart-icon" onclick="toggleCart()">ðŸ›’ Cart (<span id="cartCount">0</span>)</span>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard">
            <h2>Browse Products</h2>
            
            <div id="cartSection" class="cart-section" style="display: none;">
                <h3>Shopping Cart</h3>
                <div id="cartItems"></div>
                <div class="cart-total">
                    <strong>Total: â‚¹<span id="cartTotal">0</span></strong>
                </div>
                <button onclick="placeOrder()" class="btn btn-primary">Place Order</button>
                <button onclick="toggleCart()" class="btn btn-secondary">Continue Shopping</button>
            </div>

            <div id="productsSection" class="dashboard-section">
                <div id="productsList">
                    <p class="loading">Loading products...</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 Campus Ecommerce. All rights reserved.</p>
        </div>
    </footer>

    <script src="app.js"></script>
    <script>
        // Check if user is logged in
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        
        if (!currentUser || currentUser.role !== 'buyer') {
            alert('Please login as a buyer to access this page');
            window.location.href = 'login.html';
        }

        document.getElementById('userName').textContent = `Welcome, ${currentUser.name}`;

        let cart = [];

        // Load all products
        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:8080/products');
                const products = await response.json();
                
                const productsList = document.getElementById('productsList');
                
                if (products.length === 0) {
                    productsList.innerHTML = '<p class="no-data">No products available yet.</p>';
                } else {
                    productsList.innerHTML = `
                        <div class="product-grid">
                            ${products.map(product => `
                                <div class="product-card">
                                    <h3>${product.name}</h3>
                                    <p class="price">â‚¹${product.price}</p>
                                    <p class="stock">Stock: ${product.stock}</p>
                                    ${product.stock > 0 ? 
                                        `<button onclick="addToCart(${product.id}, '${product.name}', ${product.price}, ${product.stock})" class="btn btn-primary btn-sm">Add to Cart</button>` :
                                        `<button class="btn btn-secondary btn-sm" disabled>Out of Stock</button>`
                                    }
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsList').innerHTML = 
                    '<p class="error">Error loading products. Please make sure the backend is running.</p>';
            }
        }

        function addToCart(id, name, price, stock) {
            const existingItem = cart.find(item => item.id === id);
            
            if (existingItem) {
                if (existingItem.quantity < stock) {
                    existingItem.quantity++;
                } else {
                    alert('Cannot add more items than available in stock');
                    return;
                }
            } else {
                cart.push({ id, name, price, quantity: 1, stock });
            }
            
            updateCart();
            alert(`${name} added to cart!`);
        }

        function updateCart() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = cartCount;
            
            const cartItems = document.getElementById('cartItems');
            const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="no-data">Your cart is empty</p>';
            } else {
                cartItems.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Subtotal</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cart.map((item, index) => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>â‚¹${item.price}</td>
                                    <td>
                                        <button onclick="updateQuantity(${index}, -1)" class="btn-qty">-</button>
                                        ${item.quantity}
                                        <button onclick="updateQuantity(${index}, 1)" class="btn-qty">+</button>
                                    </td>
                                    <td>â‚¹${(item.price * item.quantity).toFixed(2)}</td>
                                    <td><button onclick="removeFromCart(${index})" class="btn btn-danger btn-sm">Remove</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            document.getElementById('cartTotal').textContent = cartTotal.toFixed(2);
        }

        function updateQuantity(index, change) {
            const item = cart[index];
            const newQuantity = item.quantity + change;
            
            if (newQuantity <= 0) {
                removeFromCart(index);
            } else if (newQuantity <= item.stock) {
                item.quantity = newQuantity;
                updateCart();
            } else {
                alert('Cannot add more items than available in stock');
            }
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart();
        }

        function toggleCart() {
            const cartSection = document.getElementById('cartSection');
            const productsSection = document.getElementById('productsSection');
            
            if (cartSection.style.display === 'none') {
                cartSection.style.display = 'block';
                productsSection.style.display = 'none';
                updateCart();
            } else {
                cartSection.style.display = 'none';
                productsSection.style.display = 'block';
            }
        }

        async function placeOrder() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Note: This is a simplified order placement
            // In a real application, you would send the cart items to the backend
            alert(`Order placed successfully!\nTotal: â‚¹${total.toFixed(2)}\n\nThank you for your purchase!`);
            
            cart = [];
            updateCart();
            toggleCart();
            loadProducts();
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Load products on page load
        window.addEventListener('DOMContentLoaded', loadProducts);
    </script>
</body>
</html>

